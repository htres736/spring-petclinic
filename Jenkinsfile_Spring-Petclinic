pipeline{
    agent{
        label 'master'
    }
    tools{
        maven 'Maven 3.3.9'
        jdk 'JDK 11'
    }
    stages{
        stage('Checkout the code') {
            steps{
                git branch: 'main', url:'https://github.com/htres736/spring-petclinic.git'
            }
        }
        stage('Parallel Block') {
            parallel{
                stage('Code Validate'){
                    steps{
                    
                        sh """
                            echo "compile code"
                            mvn validate
                            echo "code compile complete"
                        """
                    }
                }
                stage('Code Compile'){
                    steps{
                        
                        sh """
                            echo "compile code"
                            mvn compile
                            echo "code compile complete"
                        """
                        
                        }
                }
            }
        }
        stage('JUnit Test'){
            when{ expression{returnenv.TESTVAR.contains('YES')}}
            steps{
                
                sh """
                    echo "unit test code"
                    mvn test
                    echo "unit tests complete"
                """
                
            }
        }
        stage ('Packaging'){
            steps{
                catchError (buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                sh """
                    echo "package code"
                    mvn package
                    echo "code packaging complete"
                """
                }
            }
        }
    }
    post{
        always{
            junit 'target/surefire-reports/**/*.xml'
        }
    }
}
